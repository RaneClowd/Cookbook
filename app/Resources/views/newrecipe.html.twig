{% extends 'base.html.twig' %}

{% block body %}
    <input id='recipeName' type='text' class="form-control" placeholder='Recipe Name'>
    <hr>
    <form class="form-inline" role="form">
        <div id="ingredientList">
                <div id='ingredientTemplate' class="form-group" style="display: none;">
                    <input type='text' class='amount form-control' placeholder='amount' oninput="checkIsLast(this);">
                    <div class='unit form-control dropdown'>
                        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            Dropdown
                        </button>
                        <ul class="dropdown-menu">
                            {% for measureClass in measureArray %}
                                <li class="dropdown-header">{{ measureClass.getMeasureName }}</li>
                                {% for unit in measureClass.getAvailableMeasureUnits|keys %}
                                    <li><a href="#">{{ unit }}</a></li>
                                {% endfor %}
                                {% if not loop.last %}
                                    <li role="separator" class="divider"></li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                    <input type='text' class='name form-control' placeholder='name' oninput="checkIsLast(this);">
                </div>
        </div>
    </form>
    <hr>
    <form class="form-inline" role="form">
        <div id="stepList">
                <div id='stepTemplate' style="display: none;">
                        <textarea rows='5' cols='80' class="form-control" oninput="checkIsLast(this);"></textarea>
                </div>
        </div>
    </form>
    <br>
    <button id="saveBtn" class="btn btn-default" onclick="save();">Save</button>
    <p></p>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    
    <script>
        var loadFinished = false;
        $(document).ready(function() {
            addIngredient();
            addStep();
            
            $('#ingredientList').bind('addNew', function() {
                addIngredient();
            });
            
            $('#stepList').bind('addNew', function() {
                addStep();
            });
            
            loadFinished = true;
        });
        
        function checkIsLast(sender) {
            var rowItem = $(sender).parent();
            if (rowItem.is(':last-child')) {
                rowItem.parent().trigger('addNew');
            }
        }
        
        function removableClonedFrom(template) {
            var newItem = template.clone();
            newItem.removeAttr('id');
            if (loadFinished == true) newItem.append("<button onclick='removeClicked(this);' class='btn btn-default'>&times;</button>");
            newItem.show();
            return newItem;
        }
        
        function addIngredient() {
            var newIngredient = removableClonedFrom( $("#ingredientTemplate") );
            
            newIngredient.find('.dropdown .dropdown-menu li a').each(function(){
                $(this).click(function(){
                    console.log('clicked');
                    var selText = $(this).text();
                    $(this).parents('.dropdown').find('.dropdown-toggle').html(selText);
                })
            });
            
            newIngredient.addClass('ingredientListItem');
            $("#ingredientList").append(newIngredient);
        }
        
        function addStep() {
            var newStep = removableClonedFrom( $("#stepTemplate") );
            newStep.addClass('stepListItem');
            $("#stepList").append(newStep);
        }
        
        function removeClicked(sender) {
            $(sender).parent().remove();
        }
        
        function newRecipe(name) {
            return {name:name, ingredients:[], steps:[]};
        }
        
        function newIngredient(amount, unit, name) {
            return {amount:amount, unit:unit, name:name};
        }
        
        function showSaving(saveBtn) {
            var notifier = $('<span class="label label-default"></span>')
            notifier.html("Saving...");
            saveBtn.hide();
            saveBtn.before(notifier);
            return notifier;
        }
        
        function saveComplete(notifier) {
            displayMessageAlertWithClass('alert-success', $('#recipeName').val() + ' recipe saved!');
            notifier.remove();
            resetForm();
        }
        
        function resetForm() {
            $(".ingredientListItem").remove();
            $(".stepListItem").remove();
            
            $('#recipeName').val('');
            addIngredient();
            addStep();
            
            $('#saveBtn').show();
        }
        
        function saveError(notifier, saveBtn) {
            notifier.remove();
            displayMessageAlertWithClass('alert-danger', 'Error! Try again?');
            
            $('#saveBtn').show();
        }
        
        function save() {
            $('.alert:visible').remove();
            
            var recipe = newRecipe($("#recipeName").val());
            $(".ingredientListItem").each(function() {
                var amountVal = $(this).children(".amount").val();
                var unitVal = $(this).children(".unit").val();
                var nameVal = $(this).children(".name").val();
                
                if (amountVal != '' || unitVal != '' || nameVal != '') {
                    var ingredient = newIngredient(amountVal, unitVal, nameVal);
                    recipe.ingredients.push(ingredient);
                } else {
                    $(this).remove();
                }
            });
            $(".stepListItem").each(function() {
                var step = $(this).children("textarea").val();
                if (step != '') {
                    recipe.steps.push(step);
                } else {
                    $(this).remove();
                }
            });
            
            var saveBtn = $('#saveBtn');
            var notifier = showSaving(saveBtn);
            
            $.ajax({
                url:"{{ path("save_recipe") }}",
                type: 'post',
                data: JSON.stringify(recipe),
                contentType: 'application/json',
                dataType: 'json',
                success: function(result) {
                    saveComplete(notifier);
                },
                error: function () {
                    saveError(notifier, saveBtn);
                }
            });
        }
    </script>
{% endblock %}